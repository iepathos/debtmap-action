name: 'Debtmap - Code Complexity Analyzer'
description: 'Analyze code complexity and identify high-risk areas by correlating complexity metrics with test coverage'
author: 'iepathos'
branding:
  icon: 'activity'
  color: 'orange'

inputs:
  lcov-file:
    description: 'Path to LCOV coverage file (optional - enables risk correlation analysis)'
    required: false
    default: ''

  coverage-file:
    description: 'Alias for lcov-file (for compatibility with different workflows)'
    required: false
    default: ''

  path:
    description: 'Path to the project to analyze'
    required: false
    default: '.'

  debtmap-version:
    description: 'Version of debtmap to use (latest or specific version like v0.1.0)'
    required: false
    default: 'latest'

  command:
    description: 'Command to run: "analyze" (show tech debt issues) or "validate" (enforce thresholds)'
    required: false
    default: 'analyze'

  format:
    description: 'Output format: markdown, json, or text'
    required: false
    default: 'markdown'

  output-file:
    description: 'Output file path (auto-generated based on format if not specified)'
    required: false
    default: ''

  fail-on-threshold:
    description: 'Fail the job if tech debt exceeds thresholds (only applies to validate command)'
    required: false
    default: 'false'

outputs:
  report-path:
    description: 'Path to the generated report file'
    value: ${{ steps.analyze.outputs.report-path }}

runs:
  using: 'composite'
  steps:
    - name: Install debtmap
      shell: bash
      run: |
        # Detect platform
        OS=$(uname -s | tr '[:upper:]' '[:lower:]')
        ARCH=$(uname -m)

        # Map to release binary names
        case "${OS}-${ARCH}" in
          linux-x86_64)    PLATFORM="x86_64-unknown-linux-gnu" ;;
          linux-aarch64)   PLATFORM="aarch64-unknown-linux-gnu" ;;
          darwin-x86_64)   PLATFORM="x86_64-apple-darwin" ;;
          darwin-arm64)    PLATFORM="aarch64-apple-darwin" ;;
          *)
            echo "Unsupported platform: ${OS}-${ARCH}"
            exit 1
            ;;
        esac

        # Get version
        VERSION="${{ inputs.debtmap-version }}"
        if [ "$VERSION" == "latest" ]; then
          VERSION=$(curl -sSL https://api.github.com/repos/iepathos/debtmap/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
        fi
        [[ "$VERSION" != v* ]] && VERSION="v$VERSION"

        # Download and install
        URL="https://github.com/iepathos/debtmap/releases/download/${VERSION}/debtmap-${PLATFORM}"
        echo "Installing debtmap ${VERSION} for ${PLATFORM}..."
        curl -sSL -o debtmap "$URL"
        chmod +x debtmap
        ./debtmap --version

    - name: Run debtmap analysis
      id: analyze
      shell: bash
      run: |
        # Determine coverage file (coverage-file takes precedence for compatibility)
        COVERAGE_FILE="${{ inputs.coverage-file }}"
        if [ -z "$COVERAGE_FILE" ]; then
          COVERAGE_FILE="${{ inputs.lcov-file }}"
        fi

        # Determine output file
        FORMAT="${{ inputs.format }}"
        OUTPUT_FILE="${{ inputs.output-file }}"
        if [ -z "$OUTPUT_FILE" ]; then
          case "$FORMAT" in
            json) OUTPUT_FILE="debtmap-report.json" ;;
            text) OUTPUT_FILE="debtmap-report.txt" ;;
            *)    OUTPUT_FILE="debtmap-report.md" ;;
          esac
        fi

        # Build the debtmap command
        COMMAND="${{ inputs.command }}"
        CMD="./debtmap $COMMAND ${{ inputs.path }}"

        # Add coverage file if provided
        if [ -n "$COVERAGE_FILE" ]; then
          CMD="$CMD --coverage-file $COVERAGE_FILE"
        fi

        # Add format and output
        CMD="$CMD --format $FORMAT --output $OUTPUT_FILE"

        # Run the command
        echo "Running: $CMD"
        if [ "${{ inputs.fail-on-threshold }}" == "true" ]; then
          # Run with error propagation for validate mode
          $CMD
        else
          # Run but don't fail on threshold violations
          $CMD || true
        fi

        # Set output
        echo "report-path=$OUTPUT_FILE" >> $GITHUB_OUTPUT

        # Generate GitHub step summary (only for markdown format)
        if [ -n "$GITHUB_STEP_SUMMARY" ] && [ "$FORMAT" == "markdown" ]; then
          {
            echo "## ðŸ“Š Debtmap $COMMAND Results"
            echo ""
            if [ -f "$OUTPUT_FILE" ]; then
              cat "$OUTPUT_FILE"
            else
              echo "Analysis complete. Report saved to: $OUTPUT_FILE"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
        elif [ -n "$GITHUB_STEP_SUMMARY" ]; then
          {
            echo "## ðŸ“Š Debtmap $COMMAND Results"
            echo ""
            echo "Report saved to: \`$OUTPUT_FILE\` (format: $FORMAT)"
          } >> "$GITHUB_STEP_SUMMARY"
        fi

    - name: Upload debtmap report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: debtmap-report
        path: ${{ steps.analyze.outputs.report-path }}
        retention-days: 7